# Active Context (2025-04-17 Router Implementation)

## Current Focus
- Basic router implementation (`@sylph/router`) and framework integrations (`@sylph/router-react`, `@sylph/router-preact`) created.
- Build issues related to declaration file generation resolved.
- Next Focus: Add tests for router packages, implement remaining router features (e.g., link interception), consider packaging/documentation.

## Status
- **Code State:**
    - `@sylph/core`: Stable after feature restoration (commit `66f2172`). Minor `as any` casts and a suppressed error remain.
    - `@sylph/router`: Basic implementation complete (store, history handling, route matching, route definition).
    - `@sylph/router-react`: Basic `useRouter` hook implemented.
    - `@sylph/router-preact`: Basic `useRouter` hook implemented.
- **Naming:** Core factory functions use shorter names (`atom`, `computed`, `map`, etc.).
- **Build:** Build process fixed and successful for all packages (`tsc` for core declarations, `tsup` for bundling).
- **Tests:** Core tests pass. Router tests need to be added.
- **Benchmarks:** Core benchmarks run. Router benchmarks need to be added. Size checks need re-run.

## Recent Changes & Decisions
- **Router Implementation:**
    - Created `@sylph/router` package structure.
    - Implemented core `$router` map store (`index.ts`).
    - Implemented URL parsing utilities (`utils.ts`).
    - Implemented browser history interaction (`history.ts`: `updateStateFromLocation`, `popstate` listener, `open`, `redirect`).
    - Implemented basic route matching (`matcher.ts`: `pathToRegexp`, `matchRoutes`).
    - Implemented route definition management (`routes.ts`: `defineRoutes`, `getRoutes`).
    - Integrated matcher and route definitions into history handling.
- **Framework Integrations:**
    - Created `@sylph/router-react` package structure and basic `useRouter` hook.
    - Created `@sylph/router-preact` package structure and basic `useRouter` hook.
- **Build Troubleshooting:**
    - Diagnosed persistent build failures related to DTS generation in `@sylph/core`.
    - Attempted fixes: cleaning, reinstalling deps, changing export styles, modifying `tsup` DTS options.
    - **Resolved by:** Separating declaration generation (`tsc`) from JS bundling (`tsup`) in `@sylph/core`'s build script and ensuring `tsup` (`dts: true`) bundles the declarations generated by `tsc`.

## Next Steps
- **Add tests for `@sylph/router`, `@sylph/router-react`, `@sylph/router-preact`.**
- Implement remaining router TODOs (link click interception).
- Consider packaging/documentation/release for all packages.
- Re-run benchmarks and size checks for all packages.
- Address remaining `as any` casts in `@sylph/core` if feasible.
- Address suppressed error in `@sylph/core/map.ts` (`@ts-expect-error`).
- Address guideline compliance task (fetching `guidelines/typescript/style_quality.md`) if it becomes available.

## Active Decisions
- Router structure established (store, history, matcher, routes modules).
- React/Preact hooks implemented using `useState`/`useEffect`.
- Build process fixed using `tsc && tsup` for core package.

## Guideline Verification Issues
- **Persistent Failure:** Repeated attempts to fetch `guidelines/typescript/style_quality.md` failed (GitHub 404 Not Found - latest attempt 2025-04-16). Cleanup/review proceeded based on existing code style, user instructions, and best practices. The compliance task remains pending.